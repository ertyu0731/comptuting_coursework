{% extends 'base.html' %}
{% block title %}Tasks{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Table of Tasks</h1>
        <p class="page-subtitle">Manage all your tasks in one place</p>
    </div>
    <button class="btn btn-primary" onclick="openAddTaskModal()">
        <span>+</span> Add Task
    </button>
</div>

<div class="card">
    <div class="table-container">
        <table class="data-table" id="tasks-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Due Date</th>
                    <th>Priority</th>
                    <th>Time Needed</th>
                </tr>
            </thead>
            <tbody>
                {% if tasks %}
                {% for task in tasks %}
                <tr class="task-row" data-task-id="{{ task.id }}" onclick="toggleTaskActions(this)">
                    <td><strong>{{ task.title }}</strong></td>
                    <td>{{ task.subject or '-' }}</td>
                    <td>
                        <span class="badge badge-{{ task.status|lower|replace(' ', '-') }}">
                            {{ task.status }}
                        </span>
                    </td>
                    <td>{{ task.due_date or '-' }}</td>
                    <td>
                        <span class="badge badge-{{ task.priority|lower }}">
                            {{ task.priority }}
                        </span>
                    </td>
                    <td>{{ task.time_needed }} hr{% if task.time_needed != 1 %}s{% endif %}</td>
                </tr>
                <tr class="task-actions" data-task-id="{{ task.id }}">
                    <td colspan="6">
                        <button class="btn btn-secondary btn-sm"
                            onclick="openEditTaskModal({{ task.id }}, '{{ task.title }}', '{{ task.subject }}', '{{ task.status }}', '{{ task.due_date }}', '{{ task.priority }}', {{ task.time_needed }})">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTask({{ task.id }})">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">No tasks yet</div>
                            <p>Click "Add Task" to create your first task</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Task Modal -->
<div class="modal-overlay" id="task-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Add New Task</h2>
            <button class="modal-close" onclick="closeTaskModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="task-form">
                <input type="hidden" id="task-id" value="">

                <div class="form-group">
                    <label class="form-label" for="title">Title *</label>
                    <input type="text" class="form-input" id="title" placeholder="e.g., Complete Math Homework"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="subject">Subject</label>
                    <input type="text" class="form-input" id="subject" placeholder="e.g., Mathematics">
                </div>

                <div class="form-group">
                    <label class="form-label" for="status">Status</label>
                    <select class="form-select" id="status">
                        <option value="Not Started">Not Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="due_date">Due Date</label>
                    <input type="date" class="form-input" id="due_date">
                </div>

                <div class="form-group">
                    <label class="form-label" for="priority">Priority Level</label>
                    <select class="form-select" id="priority">
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="time_needed">Time Needed (hours)</label>
                    <input type="number" class="form-input" id="time_needed" min="0.5" step="0.5" value="1"
                        placeholder="e.g., 2">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveTask()">
                <span id="save-btn-text">Create Task</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle task row expansion
    function toggleTaskActions(row) {
        const wasExpanded = row.classList.contains('expanded');

        // Close all expanded rows
        document.querySelectorAll('.task-row.expanded').forEach(r => {
            r.classList.remove('expanded');
        });

        // Toggle clicked row
        if (!wasExpanded) {
            row.classList.add('expanded');
        }
    }

    // Modal functions
    function openAddTaskModal() {
        document.getElementById('modal-title').textContent = 'Add New Task';
        document.getElementById('save-btn-text').textContent = 'Create Task';
        document.getElementById('task-form').reset();
        document.getElementById('task-id').value = '';
        document.getElementById('task-modal').classList.add('active');
    }

    function openEditTaskModal(id, title, subject, status, dueDate, priority, timeNeeded) {
        document.getElementById('modal-title').textContent = 'Edit Task';
        document.getElementById('save-btn-text').textContent = 'Save Changes';
        document.getElementById('task-id').value = id;
        document.getElementById('title').value = title;
        document.getElementById('subject').value = subject;
        document.getElementById('status').value = status;
        document.getElementById('due_date').value = dueDate;
        document.getElementById('priority').value = priority;
        document.getElementById('time_needed').value = timeNeeded;
        document.getElementById('task-modal').classList.add('active');
    }

    function closeTaskModal() {
        document.getElementById('task-modal').classList.remove('active');
    }

    // Save task (create or update)
    async function saveTask() {
        const taskId = document.getElementById('task-id').value;
        const data = {
            title: document.getElementById('title').value,
            subject: document.getElementById('subject').value,
            status: document.getElementById('status').value,
            due_date: document.getElementById('due_date').value,
            priority: document.getElementById('priority').value,
            time_needed: parseFloat(document.getElementById('time_needed').value) || 1
        };

        if (!data.title) {
            alert('Please enter a task title');
            return;
        }

        const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
        const method = taskId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to save task');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save task');
        }
    }

    // Delete task
    async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete task');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete task');
        }
    }

    // Close modal on overlay click
    document.getElementById('task-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeTaskModal();
        }
    });
</script>
{% endblock %}